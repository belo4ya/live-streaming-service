version: "3.8"

services:
  caddy:
    container_name: caddy
    image: caddy:latest
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./caddy/config/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy/config:/config
      - ./caddy/data:/data

  #  authelia:
  #    container_name: authelia
  #    image: authelia/authelia:latest
  #    environment:
  #      AUTHELIA_JWT_SECRET_FILE: /secrets/JWT_SECRET
  #      AUTHELIA_SESSION_SECRET_FILE: /secrets/SESSION_SECRET
  #      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: /secrets/STORAGE_ENCRYPTION_KEY
  #    ports:
  #      - "9091:9091"
  #    volumes:
  #      - ./authelia/config:/config
  #      - ./authelia/secrets:/secrets
  #      - ./authelia/data:/data

  prometheus:
    container_name: prometheus
    image: prom/prometheus:latest
    command: "--config.file=/etc/prometheus/prometheus.yaml"
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/config/prometheus.yaml:/etc/prometheus/prometheus.yaml:ro
  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    environment:
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/data:/var/lib/grafana
      - ./grafana/config/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus

  loki_reader:
    container_name: loki_reader
    image: grafana/loki:latest
    command: "-config.file=/etc/loki/config.yaml -target=read"
    ports:
      - "3101:3100"
      - "7946"
      - "9095"
    volumes:
      - ./loki/config/loki.yaml:/etc/loki/config.yaml
    depends_on:
      - minio_loki
  loki_writer:
    container_name: loki_writer
    image: grafana/loki:latest
    command: "-config.file=/etc/loki/config.yaml -target=write"
    ports:
      - "3102:3100"
      - "7946"
      - "9095"
    volumes:
      - ./loki/config/loki.yaml:/etc/loki/config.yaml
    depends_on:
      - minio_loki
  promtail:
    container_name: promtail
    image: grafana/promtail:latest
    command: "-config.file=/etc/promtail/config.yaml"
    volumes:
      - ./loki/config/promtail.yaml:/etc/promtail/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - loki_reader
      - loki_writer
  minio_loki:
    container_name: minio_loki
    hostname: minio-loki
    image: minio/minio:latest
    entrypoint:
      - sh
      - -euc
      - |
        mkdir -p /data/loki-data && \
        mkdir -p /data/loki-ruler && \
        minio server --console-address ":9001" /data
    environment:
      MINIO_ACCESS_KEY: minio_access_key
      MINIO_SECRET_KEY: minio_secret_key
      MINIO_PROMETHEUS_AUTH_TYPE: public
      MINIO_PROMETHEUS_URL: http://prometheus:9090
      MINIO_PROMETHEUS_JOB_ID: minio-loki
      MINIO_UPDATE: off
    ports:
      - "9000"
      - "9001:9001"
    volumes:
      - ./loki/data:/data

  flog:
    container_name: flog
    image: mingrammer/flog
    command: "-f json -d 1s -l"
